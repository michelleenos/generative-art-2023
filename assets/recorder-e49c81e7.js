var h=Object.defineProperty;var d=(t,i,e)=>i in t?h(t,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[i]=e;var s=(t,i,e)=>(d(t,typeof i!="symbol"?i+"":i,e),e);import{m as a}from"./canvas-images-d0bfdd66.js";class f{constructor({canvas:i,gui:e,fns:r,useTime:o=!1}){s(this,"recording",!1);s(this,"imgs");s(this,"needsFreshZip",!1);s(this,"framesCount",0);s(this,"maxFrames",4e3);s(this,"canvas");s(this,"gui");s(this,"guiBtnRecord");s(this,"guiBtnLoop");s(this,"guiBtnReset");s(this,"looping",!1);s(this,"lastTime",null);s(this,"zipsDownloaded",0);s(this,"imgsPerZip",700);s(this,"rafId",null);s(this,"currentId");s(this,"name","img");s(this,"useTime",!1);s(this,"fns");s(this,"reset",()=>{this.fns.reset&&this.fns.reset(),this.framesCount=0,this.lastTime=null,this.needsFreshZip=!0});s(this,"rafRecord",()=>{this.recording&&this.imgs.getImage(`${this.name}-${this.framesCount}`).then(()=>{let i=this.fns.drawRecord(this.framesCount);this.framesCount++,this.framesCount>=this.maxFrames||i?this.imgs.downloadZip():this.framesCount>(this.zipsDownloaded+1)*this.imgsPerZip?this.imgs.zipStream().then(()=>{this.zipsDownloaded++,this.lastTime=null,this.imgs=a(this.canvas,`${this.currentId}-${this.zipsDownloaded}`),requestAnimationFrame(this.rafRecord)}):requestAnimationFrame(this.rafRecord)})});s(this,"raf",()=>{let i=performance.now();this.lastTime||(this.lastTime=i);let e=i-this.lastTime;this.lastTime=i,this.fns.draw(this.useTime?i:e),this.rafId=requestAnimationFrame(this.raf)});s(this,"toggleRecord",()=>{this.recording?(this.recording=!1,this.needsFreshZip=!0,this.guiBtnRecord.name("startRecording")):(this.fns.reset&&this.fns.reset(),this.framesCount=0,this.recording=!0,this.looping=!1,this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=null,this.needsFreshZip&&(this.imgs=a(this.canvas),this.needsFreshZip=!1),this.rafRecord(),this.guiBtnRecord.name("stopRecording"))});s(this,"toggleLoop",()=>{this.looping?(this.guiBtnLoop.name("loop"),this.looping=!1,this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=null,this.lastTime=null):(this.guiBtnLoop.name("noLoop"),this.rafId=requestAnimationFrame(this.raf),this.looping=!0)});this.canvas=i;let n=new Date;this.currentId=`${this.name}-${n.getHours()}${n.getMinutes()}`,this.imgs=a(i,this.currentId),this.gui=e.addFolder("controls"),this.useTime=o,this.fns={draw:r.draw,drawRecord:r.drawRecord,reset:r.reset},this.gui.add(this,"framesCount").listen().disable(),this.gui.add(this,"maxFrames",10,1500,1).name("max frames"),this.guiBtnRecord=this.gui.add(this,"toggleRecord").name("startRecording"),this.guiBtnLoop=this.gui.add(this,"toggleLoop").name("loop"),this.guiBtnReset=this.gui.add(this,"reset").name("reset")}}export{f as R};
